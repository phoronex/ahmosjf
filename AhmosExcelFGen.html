<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>"
        type="image/svg+xml" />
    <title>Ahmos Excel Formula Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .copyright {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .formula-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .formula-card:hover {
            transform: translateY(-5px);
        }

        .formula-title {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .file-input-wrapper input[type="text"] {
            flex: 1;
        }

        .browse-btn {
            padding: 12px 25px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .browse-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .generate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .reset-btn {
            padding: 15px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .button-group {
            display: grid;
            grid-template-columns: 3fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .result-box {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            border: 2px solid #667eea;
            display: none;
        }

        .result-box.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-box h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .result-box textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
        }

        .copy-btn {
            margin-top: 10px;
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
            width: 100%;
        }

        .copy-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            user-select: none;
            color: #495057;
        }

        .add-criteria-btn {
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.3s ease;
            margin-top: 10px;
            width: 100%;
        }

        .add-criteria-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .criteria-group {
            border: 2px dashed #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            position: relative;
            background: #fafafa;
        }

        .remove-criteria-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .remove-criteria-btn:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .info-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .arabic-text {
            font-size: 52px;
            text-align: center;
            font-family: 'Amiri', Arial, Helvetica, sans-serif;;
            line-height: 1.8;
            color: #fef8fd;
            margin: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }

            .button-group {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .formula-card {
                padding: 20px;
            }

            .arabic-text {
                font-size: 36px;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="arabic-text" id="arabicText">&#x633;&#x64F;&#x628;&#x652;&#x62D;&#x64E;&#x627;&#x646;&#x64E;
        &#x627;&#x644;&#x644;&#x651;&#x64E;&#x647;&#x650;
        &#x648;&#x64E;&#x628;&#x650;&#x62D;&#x64E;&#x645;&#x652;&#x62F;&#x650;&#x647;&#x650;
        &#x633;&#x64F;&#x628;&#x652;&#x62D;&#x64E;&#x627;&#x646;&#x64E;
        &#x627;&#x644;&#x644;&#x651;&#x64E;&#x647;&#x650;
        &#x627;&#x644;&#x652;&#x639;&#x64E;&#x638;&#x650;&#x64A;&#x645;&#x650;</div>
        <div class="header">
            <h1>üìä Excel Formula Generator V2</h1>
            <p class="copyright">¬© Ahmos. All Rights Reserved.</p>
        </div>

        <!-- TEXTJOIN + FILTER Card -->
        <div class="formula-card">
            <h2 class="formula-title">üîó TEXTJOIN + FILTER Formula</h2>
            
            <div class="input-group">
                <label for="tj-filepath">Target File Path:</label>
                <div class="file-input-wrapper">
                    <input type="text" id="tj-filepath" placeholder="e.g., C:\Data\myfile.xlsx or (myfile.xlsx if already opened)">
                    <button class="browse-btn" onclick="browseFile('tj-filepath')">üìÅ Browse</button>
                </div>
                <p class="info-text">Enter the full path to your Excel file or click Browse</p>
            </div>

            <div class="grid-2">
                <div class="input-group">
                    <label for="tj-sheetname">Sheet Name:</label>
                    <input type="text" id="tj-sheetname" placeholder="e.g., Sheet1">
                </div>

                <div class="input-group">
                    <label for="tj-returncol">Return Column:</label>
                    <input type="text" id="tj-returncol" placeholder="e.g., B">
                </div>
            </div>

            <div class="grid-2">
                <div class="input-group">
                    <label for="tj-targetcol">Target Column:</label>
                    <input type="text" id="tj-targetcol" placeholder="e.g., A">
                </div>

                <div class="input-group">
                    <label for="tj-equalcell">Equal Cell:</label>
                    <input type="text" id="tj-equalcell" placeholder="e.g., A2">
                </div>
            </div>

            <div class="input-group">
                <label for="tj-error">If Error Text (Optional):</label>
                <input type="text" id="tj-error" placeholder="Leave empty or enter an error value to return">
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="tj-lock" checked>
                <label for="tj-lock">üîí Lock table ranges with $ (Absolute Reference)</label>
            </div>

            <div class="button-group">
                <button class="generate-btn" onclick="generateTextJoin()">üöÄ Generate TEXTJOIN Formula</button>
                <button class="reset-btn" onclick="resetForm('tj')">üîÑ Reset</button>
            </div>

            <div class="result-box" id="tj-result">
                <h3>Generated Formula:</h3>
                <textarea id="tj-output" readonly></textarea>
                <button class="copy-btn" onclick="copyToClipboard('tj-output')">üìã Copy Formula</button>
            </div>
        </div>

        <!-- VLOOKUP Card -->
        <div class="formula-card">
            <h2 class="formula-title">üîç VLOOKUP Formula</h2>
            
            <div class="input-group">
                <label for="vl-filepath">Target File Path:</label>
                <div class="file-input-wrapper">
                    <input type="text" id="vl-filepath" placeholder="e.g., C:\Data\myfile.xlsx or (myfile.xlsx if already opened)">
                    <button class="browse-btn" onclick="browseFile('vl-filepath')">üìÅ Browse</button>
                </div>
            </div>

            <div class="grid-2">
                <div class="input-group">
                    <label for="vl-sheetname">Sheet Name:</label>
                    <input type="text" id="vl-sheetname" placeholder="e.g., Sheet1">
                </div>

                <div class="input-group">
                    <label for="vl-lookupcell">Lookup Cell:</label>
                    <input type="text" id="vl-lookupcell" placeholder="e.g., A2">
                </div>
            </div>

            <div class="grid-2">
                <div class="input-group">
                    <label for="vl-range">Table Range:</label>
                    <input type="text" id="vl-range" placeholder="e.g., A:D">
                </div>

                <div class="input-group">
                    <label for="vl-colindex">Column Index:</label>
                    <input type="number" id="vl-colindex" placeholder="e.g., 2" min="1">
                </div>
            </div>

            <div class="input-group">
                <label for="vl-match">Match Type:</label>
                <select id="vl-match">
                    <option value="FALSE">Exact Match (FALSE)</option>
                    <option value="TRUE">Approximate Match (TRUE)</option>
                </select>
            </div>

            <div class="input-group">
                <label for="vl-error">If Error Text (Optional):</label>
                <input type="text" id="vl-error" placeholder="e.g., Not Found">
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="vl-lock" checked>
                <label for="vl-lock">üîí Lock table ranges with $ (Absolute Reference)</label>
            </div>

            <div class="button-group">
                <button class="generate-btn" onclick="generateVLookup()">üöÄ Generate VLOOKUP Formula</button>
                <button class="reset-btn" onclick="resetForm('vl')">üîÑ Reset</button>
            </div>

            <div class="result-box" id="vl-result">
                <h3>Generated Formula:</h3>
                <textarea id="vl-output" readonly></textarea>
                <button class="copy-btn" onclick="copyToClipboard('vl-output')">üìã Copy Formula</button>
            </div>
        </div>

        <!-- XLOOKUP Card -->
        <div class="formula-card" style="display: none;">
            <h2 class="formula-title">‚ö° XLOOKUP Formula</h2>
            
            <div class="input-group">
                <label for="xl-filepath">Target File Path:</label>
                <div class="file-input-wrapper">
                    <input type="text" id="xl-filepath" placeholder="e.g., C:\Data\myfile.xlsx or (myfile.xlsx if already opened)">
                    <button class="browse-btn" onclick="browseFile('xl-filepath')">üìÅ Browse</button>
                </div>
            </div>

            <div class="grid-2">
                <div class="input-group">
                    <label for="xl-sheetname">Sheet Name:</label>
                    <input type="text" id="xl-sheetname" placeholder="e.g., Sheet1">
                </div>

                <div class="input-group">
                    <label for="xl-lookupcell">Lookup Cell:</label>
                    <input type="text" id="xl-lookupcell" placeholder="e.g., A2">
                </div>
            </div>

            <div class="grid-2">
                <div class="input-group">
                    <label for="xl-lookuparray">Lookup Array:</label>
                    <input type="text" id="xl-lookuparray" placeholder="e.g., A:A">
                </div>

                <div class="input-group">
                    <label for="xl-returnarray">Return Array:</label>
                    <input type="text" id="xl-returnarray" placeholder="e.g., B:B">
                </div>
            </div>

            <div class="input-group">
                <label for="xl-notfound">If Not Found (Optional):</label>
                <input type="text" id="xl-notfound" placeholder="e.g., Not Found">
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="xl-lock" checked>
                <label for="xl-lock">üîí Lock table ranges with $ (Absolute Reference)</label>
            </div>

            <div class="button-group">
                <button class="generate-btn" onclick="generateXLookup()">üöÄ Generate XLOOKUP Formula</button>
                <button class="reset-btn" onclick="resetForm('xl')">üîÑ Reset</button>
            </div>

            <div class="result-box" id="xl-result">
                <h3>Generated Formula:</h3>
                <textarea id="xl-output" readonly></textarea>
                <button class="copy-btn" onclick="copyToClipboard('xl-output')">üìã Copy Formula</button>
            </div>
        </div>

        <!-- INDEX + MATCH Card -->
        <div class="formula-card" style="display: none;">
            <h2 class="formula-title">üéØ INDEX + MATCH Formula</h2>
            
            <div class="input-group">
                <label for="im-filepath">Target File Path:</label>
                <div class="file-input-wrapper">
                    <input type="text" id="im-filepath" placeholder="e.g., C:\Data\myfile.xlsx or (myfile.xlsx if already opened)">
                    <button class="browse-btn" onclick="browseFile('im-filepath')">üìÅ Browse</button>
                </div>
            </div>

            <div class="grid-2">
                <div class="input-group">
                    <label for="im-sheetname">Sheet Name:</label>
                    <input type="text" id="im-sheetname" placeholder="e.g., Sheet1">
                </div>

                <div class="input-group">
                    <label for="im-lookupcell">Lookup Cell:</label>
                    <input type="text" id="im-lookupcell" placeholder="e.g., A2">
                </div>
            </div>

            <div class="grid-2">
                <div class="input-group">
                    <label for="im-returnarray">Return Array:</label>
                    <input type="text" id="im-returnarray" placeholder="e.g., B:B">
                </div>

                <div class="input-group">
                    <label for="im-lookuparray">Lookup Array:</label>
                    <input type="text" id="im-lookuparray" placeholder="e.g., A:A">
                </div>
            </div>

            <div class="input-group">
                <label for="im-match">Match Type:</label>
                <select id="im-match">
                    <option value="0">Exact Match (0)</option>
                    <option value="1">Less Than (1)</option>
                    <option value="-1">Greater Than (-1)</option>
                </select>
            </div>

            <div class="input-group">
                <label for="im-error">If Error Text (Optional):</label>
                <input type="text" id="im-error" placeholder="e.g., Not Found">
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="im-lock" checked>
                <label for="im-lock">üîí Lock table ranges with $ (Absolute Reference)</label>
            </div>

            <div class="button-group">
                <button class="generate-btn" onclick="generateIndexMatch()">üöÄ Generate INDEX+MATCH Formula</button>
                <button class="reset-btn" onclick="resetForm('im')">üîÑ Reset</button>
            </div>

            <div class="result-box" id="im-result">
                <h3>Generated Formula:</h3>
                <textarea id="im-output" readonly></textarea>
                <button class="copy-btn" onclick="copyToClipboard('im-output')">üìã Copy Formula</button>
            </div>
        </div>

        <!-- SUMIF Card -->
        <div class="formula-card" style="display: none;">
            <h2 class="formula-title">‚ûï SUMIF Formula</h2>
            
            <div class="input-group">
                <label for="sf-filepath">Target File Path:</label>
                <div class="file-input-wrapper">
                    <input type="text" id="sf-filepath" placeholder="e.g., C:\Data\myfile.xlsx or (myfile.xlsx if already opened)">
                    <button class="browse-btn" onclick="browseFile('sf-filepath')">üìÅ Browse</button>
                </div>
            </div>

            <div class="grid-2">
                <div class="input-group">
                    <label for="sf-sheetname">Sheet Name:</label>
                    <input type="text" id="sf-sheetname" placeholder="e.g., Sheet1">
                </div>

                <div class="input-group">
                    <label for="sf-range">Range to Check:</label>
                    <input type="text" id="sf-range" placeholder="e.g., A:A">
                </div>
            </div>

            <div class="grid-2">
                <div class="input-group">
                    <label for="sf-criteria">Criteria Cell:</label>
                    <input type="text" id="sf-criteria" placeholder="e.g., A2">
                </div>

                <div class="input-group">
                    <label for="sf-sumrange">Sum Range:</label>
                    <input type="text" id="sf-sumrange" placeholder="e.g., B:B">
                </div>
            </div>

            <div class="input-group">
                <label for="sf-error">If Error Text (Optional):</label>
                <input type="text" id="sf-error" placeholder="e.g., 0">
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="sf-lock" checked>
                <label for="sf-lock">üîí Lock table ranges with $ (Absolute Reference)</label>
            </div>

            <div class="button-group">
                <button class="generate-btn" onclick="generateSumIf()">üöÄ Generate SUMIF Formula</button>
                <button class="reset-btn" onclick="resetForm('sf')">üîÑ Reset</button>
            </div>

            <div class="result-box" id="sf-result">
                <h3>Generated Formula:</h3>
                <textarea id="sf-output" readonly></textarea>
                <button class="copy-btn" onclick="copyToClipboard('sf-output')">üìã Copy Formula</button>
            </div>
        </div>

        <!-- COUNTIF Card -->
        <div class="formula-card" style="display: none;">
            <h2 class="formula-title">üî¢ COUNTIF Formula</h2>
            
            <div class="input-group">
                <label for="cf-filepath">Target File Path:</label>
                <div class="file-input-wrapper">
                    <input type="text" id="cf-filepath" placeholder="e.g., C:\Data\myfile.xlsx or (myfile.xlsx if already opened)">
                    <button class="browse-btn" onclick="browseFile('cf-filepath')">üìÅ Browse</button>
                </div>
            </div>

            <div class="grid-2">
                <div class="input-group">
                    <label for="cf-sheetname">Sheet Name:</label>
                    <input type="text" id="cf-sheetname" placeholder="e.g., Sheet1">
                </div>

                <div class="input-group">
                    <label for="cf-range">Range to Count:</label>
                    <input type="text" id="cf-range" placeholder="e.g., A:A">
                </div>
            </div>

            <div class="input-group">
                <label for="cf-criteria">Criteria Cell:</label>
                <input type="text" id="cf-criteria" placeholder="e.g., A2">
            </div>

            <div class="input-group">
                <label for="cf-error">If Error Text (Optional):</label>
                <input type="text" id="cf-error" placeholder="e.g., 0">
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="cf-lock" checked>
                <label for="cf-lock">üîí Lock table ranges with $ (Absolute Reference)</label>
            </div>

            <div class="button-group">
                <button class="generate-btn" onclick="generateCountIf()">üöÄ Generate COUNTIF Formula</button>
                <button class="reset-btn" onclick="resetForm('cf')">üîÑ Reset</button>
            </div>

            <div class="result-box" id="cf-result">
                <h3>Generated Formula:</h3>
                <textarea id="cf-output" readonly></textarea>
                <button class="copy-btn" onclick="copyToClipboard('cf-output')">üìã Copy Formula</button>
            </div>
        </div>

        <!-- SUMIFS Card -->
        <div class="formula-card" style="display: none;">
            <h2 class="formula-title">‚ûï‚úñÔ∏è SUMIFS Formula (Multiple Criteria)</h2>
            
            <div class="input-group">
                <label for="sfs-filepath">Target File Path:</label>
                <div class="file-input-wrapper">
                    <input type="text" id="sfs-filepath" placeholder="e.g., C:\Data\myfile.xlsx or (myfile.xlsx if already opened)">
                    <button class="browse-btn" onclick="browseFile('sfs-filepath')">üìÅ Browse</button>
                </div>
            </div>

            <div class="grid-2">
                <div class="input-group">
                    <label for="sfs-sheetname">Sheet Name:</label>
                    <input type="text" id="sfs-sheetname" placeholder="e.g., Sheet1">
                </div>

                <div class="input-group">
                    <label for="sfs-sumrange">Sum Range:</label>
                    <input type="text" id="sfs-sumrange" placeholder="e.g., C:C">
                </div>
            </div>

            <div id="sfs-criteria-container">
                <div class="criteria-group">
                    <div class="grid-2">
                        <div class="input-group">
                            <label>Criteria Range 1:</label>
                            <input type="text" class="sfs-range" placeholder="e.g., A:A">
                        </div>

                        <div class="input-group">
                            <label>Criteria Cell 1:</label>
                            <input type="text" class="sfs-criteria" placeholder="e.g., A2">
                        </div>
                    </div>
                </div>
            </div>

            <button class="add-criteria-btn" onclick="addSumIfsCriteria()">‚ûï Add More Criteria</button>

            <div class="input-group">
                <label for="sfs-error">If Error Text (Optional):</label>
                <input type="text" id="sfs-error" placeholder="e.g., 0">
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="sfs-lock" checked>
                <label for="sfs-lock">üîí Lock table ranges with $ (Absolute Reference)</label>
            </div>

            <div class="button-group">
                <button class="generate-btn" onclick="generateSumIfs()">üöÄ Generate SUMIFS Formula</button>
                <button class="reset-btn" onclick="resetForm('sfs')">üîÑ Reset</button>
            </div>

            <div class="result-box" id="sfs-result">
                <h3>Generated Formula:</h3>
                <textarea id="sfs-output" readonly></textarea>
                <button class="copy-btn" onclick="copyToClipboard('sfs-output')">üìã Copy Formula</button>
            </div>
        </div>
    </div>

    <script>
        // Helper function to normalize backslashes
        function normalizeBackslashes(path) {
            // Replace all escaped backslashes (\\) with a placeholder
            // Then replace single backslashes (\) with double backslashes (\\)
            // This handles the JavaScript string escape issue
            
            // First, temporarily replace any existing \\ with a unique marker
            let normalized = path.replace(/\\\\/g, '<<<DOUBLE_BACKSLASH>>>');
            
            // Then replace remaining single \ with \\
            normalized = normalized.replace(/\\/g, '\\\\');
            
            // Finally, restore the original double backslashes
            normalized = normalized.replace(/<<<DOUBLE_BACKSLASH>>>/g, '\\\\');
            
            return normalized;
        }

        // Helper function to validate and format file path for Excel formulas
        function processFilePath(filePath) {
            if (!filePath) return { valid: false, formatted: '', error: 'File path is required' };
            
            // Step 1: Remove quotes from start and end
            let cleanPath = filePath.trim();
            if ((cleanPath.startsWith('"') && cleanPath.endsWith('"')) || 
                (cleanPath.startsWith("'") && cleanPath.endsWith("'"))) {
                cleanPath = cleanPath.slice(1, -1);
            } else if (cleanPath.startsWith('"') || cleanPath.startsWith("'")) {
                cleanPath = cleanPath.slice(1);
            } else if (cleanPath.endsWith('"') || cleanPath.endsWith("'")) {
                cleanPath = cleanPath.slice(0, -1);
            }
            
            cleanPath = cleanPath.trim();
            
            // Step 2: Check for valid Excel file extension
            const validExtensions = ['.xlsx', '.xlsm', '.xlsb', '.xls'];
            const hasValidExtension = validExtensions.some(ext => 
                cleanPath.toLowerCase().endsWith(ext)
            );
            
            if (!hasValidExtension) {
                return { 
                    valid: false, 
                    formatted: '', 
                    error: 'Invalid file extension. Must be .xlsx, .xlsm, .xlsb, or .xls' 
                };
            }
            
            // Step 3: Detect if it's a full path
            // Check for drive letter (C:), UNC path (\\), or forward slashes
            const isDrivePath = /^[A-Za-z]:/.test(cleanPath);
            const isUNCPath = cleanPath.startsWith('\\\\') || cleanPath.startsWith('//');
            const hasSlashes = cleanPath.includes('\\') || cleanPath.includes('/');
            
            const isFullPath = isDrivePath || isUNCPath || (hasSlashes && !cleanPath.startsWith('['));
            
            let formattedPath;
            
            if (isFullPath) {
                // Full path: Extract directory and filename
                let lastSlashIndex = -1;
                
                // Find the last occurrence of either slash type
                for (let i = cleanPath.length - 1; i >= 0; i--) {
                    if (cleanPath[i] === '\\' || cleanPath[i] === '/') {
                        lastSlashIndex = i;
                        break;
                    }
                }
                
                if (lastSlashIndex !== -1) {
                    const directory = cleanPath.substring(0, lastSlashIndex + 1);
                    const fileName = cleanPath.substring(lastSlashIndex + 1);
                    
                    // Output always has single backslash
                    formattedPath = directory + '[' + fileName + ']';
                } else {
                    formattedPath = '[' + cleanPath + ']';
                }
            } else {
                // Just filename: ExternalFile.xlsx -> [ExternalFile.xlsx]
                formattedPath = '[' + cleanPath + ']';
            }
            
            return { 
                valid: true, 
                formatted: formattedPath, 
                error: '',
                isFullPath: isFullPath,
                originalPath: cleanPath
            };
        }

        // Updated formatFilePath function - returns clean format for Excel
        function formatFilePath(filePath) {
            const result = processFilePath(filePath);
            
            if (!result.valid) {
                alert(result.error);
                return '';
            }
            
            // Return the formatted path
            return result.formatted;
        }

        // Advanced browse file function with full path support
        function browseFile(inputId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls,.xlsm,.xlsb';
            
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById(inputId).value = file.name;
                }
            };
            
            input.click();
        }

        // Helper function to add $ to range based on lock status
        function formatRange(range, lock) {
            if (!lock) return range;
            
            // Handle different range formats
            // Single column: A:A -> $A:$A
            // Range: A:D -> $A:$D
            // Single cell range: A1:A100 -> $A$1:$A$100
            // Single cell: A1 -> $A$1
            // Single column letter: B -> $B
            
            const parts = range.split(':');
            
            if (parts.length === 1) {
                // Single reference like "A" or "A1"
                const part = parts[0];
                if (part.match(/^[A-Z]+$/)) {
                    // Single column letter like "A", "B", etc.
                    return `$${part}`;
                } else {
                    // Single cell reference like "A1", "B10", etc.
                    const col = part.replace(/[0-9]/g, '');
                    const row = part.replace(/[A-Z]/g, '');
                    return `$${col}$${row}`;
                }
            } else if (parts.length === 2) {
                // Range format
                const start = parts[0];
                const end = parts[1];
                
                // Check if it's a column range (A:A, A:D)
                if (start.match(/^[A-Z]+$/) && end.match(/^[A-Z]+$/)) {
                    return `$${start}:$${end}`;
                } 
                // Check if it's a cell range (A1:D10)
                else {
                    const startCol = start.replace(/[0-9]/g, '');
                    const startRow = start.replace(/[A-Z]/g, '');
                    const endCol = end.replace(/[0-9]/g, '');
                    const endRow = end.replace(/[A-Z]/g, '');
                    
                    return `$${startCol}$${startRow}:$${endCol}$${endRow}`;
                }
            }
            
            return range; // fallback for unexpected formats
        }
      
        /**
        // Test cases:
        console.log(formatFilePath('C:\\MyFolder\\ExternalFile.xlsx')); 
        // Returns: "C:\MyFolder\[ExternalFile.xlsx]"

        console.log(formatFilePath('ExternalFile.xlsx')); 
        // Returns: "[ExternalFile.xlsx]"

        console.log(formatFilePath('"C:\\MyFolder\\ExternalFile.xlsx"')); 
        // Returns: "C:\MyFolder\[ExternalFile.xlsx]"

        console.log(formatFilePath('"ExternalFile.xlsx"')); 
        // Returns: "[ExternalFile.xlsx]"

        console.log(formatFilePath('file.txt')); 
        // Throws error: "Invalid file extension..."
        
        console.log(formatFilePath('"C:\Data\Subfolder\file.xlsx"')); 
        */

        function generateTextJoin() {
            const filePath = document.getElementById('tj-filepath').value;
            const sheetName = document.getElementById('tj-sheetname').value;
            const returnCol = document.getElementById('tj-returncol').value.toLocaleUpperCase('en-US');
            const targetCol = document.getElementById('tj-targetcol').value.toLocaleUpperCase('en-US');
            const equalCell = document.getElementById('tj-equalcell').value.toLocaleUpperCase('en-US');
            const errorStr = document.getElementById('tj-error').value;
            const lock = document.getElementById('tj-lock').checked;

            if (!filePath || !sheetName || !returnCol || !targetCol || !equalCell) {
                alert('Please fill in all required fields!');
                return;
            }
            
            // const resultPath = formatFilePath(filePath)
            const result = processFilePath(filePath);
            if (!result.valid) {
                alert(result.error);
                return;
            }
            const resultPath = result.formatted;

            let formula;
            if (lock) {
                formula = `=IFERROR(TEXTJOIN("|", TRUE, FILTER('${resultPath}${sheetName}'!$${returnCol}:$${returnCol}&"", '${resultPath}${sheetName}'!$${targetCol}:$${targetCol}&""=${equalCell}&"", "")),"${errorStr}")`;
            } else {
                formula = `=IFERROR(TEXTJOIN("|", TRUE, FILTER('${resultPath}${sheetName}'!${returnCol}:${returnCol}&"", '${resultPath}${sheetName}'!${targetCol}:${targetCol}&""=${equalCell}&"", "")),"${errorStr}")`;
            }

            document.getElementById('tj-output').value = formula;
            document.getElementById('tj-result').classList.add('show');
        }

        function generateVLookup() {
            const filePath = document.getElementById('vl-filepath').value;
            const sheetName = document.getElementById('vl-sheetname').value;
            const lookupCell = document.getElementById('vl-lookupcell').value.toLocaleUpperCase('en-US');
            const range = document.getElementById('vl-range').value.toLocaleUpperCase('en-US');
            const colIndex = document.getElementById('vl-colindex').value;
            const matchType = document.getElementById('vl-match').value;
            const errorStr = document.getElementById('vl-error').value;
            const lock = document.getElementById('vl-lock').checked;

            if (!filePath || !sheetName || !lookupCell || !range || !colIndex) {
                alert('Please fill in all required fields!');
                return;
            }
            
            const result = processFilePath(filePath);
            if (!result.valid) {
                alert(result.error);
                return;
            }
            const resultPath = result.formatted;
            const formattedRange = formatRange(range, lock);
            
            let formula;
            formula = `=IFERROR(VLOOKUP(${lookupCell},'${resultPath}${sheetName}'!${formattedRange},${colIndex},${matchType}),IFERROR(VLOOKUP(${lookupCell}&"",'${resultPath}${sheetName}'!${formattedRange},${colIndex},${matchType}),IFERROR(VLOOKUP(${lookupCell}*1,'${resultPath}${sheetName}'!${formattedRange},${colIndex},${matchType}),IFERROR(VLOOKUP(VALUE(${lookupCell}),'${resultPath}${sheetName}'!${formattedRange},${colIndex},${matchType}),"${errorStr}"))))`;
            document.getElementById('vl-output').value = formula;
            document.getElementById('vl-result').classList.add('show');
        }

        function generateXLookup() {
            const filePath = document.getElementById('xl-filepath').value;
            const sheetName = document.getElementById('xl-sheetname').value;
            const lookupCell = document.getElementById('xl-lookupcell').value;
            const lookupArray = document.getElementById('xl-lookuparray').value;
            const returnArray = document.getElementById('xl-returnarray').value;
            const notFound = document.getElementById('xl-notfound').value;
            const lock = document.getElementById('xl-lock').checked;

            if (!filePath || !sheetName || !lookupCell || !lookupArray || !returnArray) {
                alert('Please fill in all required fields!');
                return;
            }

            let formula;
            if (lock) {
                formula = `=XLOOKUP(${lookupCell}&"",'[${filePath}]${sheetName}'!${lookupArray}&"",'[${filePath}]${sheetName}'!${returnArray}`;
            } else {
                formula = `=XLOOKUP(${lookupCell}&"",'[${filePath}]${sheetName}'!${lookupArray}&"",'[${filePath}]${sheetName}'!${returnArray}`;
            }
            
            if (notFound) {
                formula += `,"${notFound}"`;
            }
            
            formula += ')';

            document.getElementById('xl-output').value = formula;
            document.getElementById('xl-result').classList.add('show');
        }

        function generateIndexMatch() {
            const filePath = document.getElementById('im-filepath').value;
            const sheetName = document.getElementById('im-sheetname').value;
            const lookupCell = document.getElementById('im-lookupcell').value;
            const returnArray = document.getElementById('im-returnarray').value;
            const lookupArray = document.getElementById('im-lookuparray').value;
            const matchType = document.getElementById('im-match').value;
            const errorStr = document.getElementById('im-error').value;
            const lock = document.getElementById('im-lock').checked;

            if (!filePath || !sheetName || !lookupCell || !returnArray || !lookupArray) {
                alert('Please fill in all required fields!');
                return;
            }

            let formula;
            if (lock) {
                formula = `=IFERROR(INDEX('[${filePath}]${sheetName}'!${returnArray},MATCH(${lookupCell}&"",'[${filePath}]${sheetName}'!${lookupArray}&"",${matchType})),"${errorStr}")`;
            } else {
                formula = `=IFERROR(INDEX('[${filePath}]${sheetName}'!${returnArray},MATCH(${lookupCell}&"",'[${filePath}]${sheetName}'!${lookupArray}&"",${matchType})),"${errorStr}")`;
            }

            document.getElementById('im-output').value = formula;
            document.getElementById('im-result').classList.add('show');
        }

        function generateSumIf() {
            const filePath = document.getElementById('sf-filepath').value;
            const sheetName = document.getElementById('sf-sheetname').value;
            const range = document.getElementById('sf-range').value;
            const criteria = document.getElementById('sf-criteria').value;
            const sumRange = document.getElementById('sf-sumrange').value;
            const errorStr = document.getElementById('sf-error').value;
            const lock = document.getElementById('sf-lock').checked;

            if (!filePath || !sheetName || !range || !criteria || !sumRange) {
                alert('Please fill in all required fields!');
                return;
            }

            let formula;
            if (lock) {
                formula = `=IFERROR(SUMIF('[${filePath}]${sheetName}'!${range}&"",${criteria}&"",'[${filePath}]${sheetName}'!${sumRange}),"${errorStr}")`;
            } else {
                formula = `=IFERROR(SUMIF('[${filePath}]${sheetName}'!${range}&"",${criteria}&"",'[${filePath}]${sheetName}'!${sumRange}),"${errorStr}")`;
            }

            document.getElementById('sf-output').value = formula;
            document.getElementById('sf-result').classList.add('show');
        }

        function generateCountIf() {
            const filePath = document.getElementById('cf-filepath').value;
            const sheetName = document.getElementById('cf-sheetname').value;
            const range = document.getElementById('cf-range').value;
            const criteria = document.getElementById('cf-criteria').value;
            const errorStr = document.getElementById('cf-error').value;
            const lock = document.getElementById('cf-lock').checked;

            if (!filePath || !sheetName || !range || !criteria) {
                alert('Please fill in all required fields!');
                return;
            }

            let formula;
            if (lock) {
                formula = `=IFERROR(COUNTIF('[${filePath}]${sheetName}'!${range}&"",${criteria}&""),"${errorStr}")`;
            } else {
                formula = `=IFERROR(COUNTIF('[${filePath}]${sheetName}'!${range}&"",${criteria}&""),"${errorStr}")`;
            }

            document.getElementById('cf-output').value = formula;
            document.getElementById('cf-result').classList.add('show');
        }

        function generateSumIfs() {
            const filePath = document.getElementById('sfs-filepath').value;
            const sheetName = document.getElementById('sfs-sheetname').value;
            const sumRange = document.getElementById('sfs-sumrange').value;
            const errorStr = document.getElementById('sfs-error').value;
            const lock = document.getElementById('sfs-lock').checked;

            if (!filePath || !sheetName || !sumRange) {
                alert('Please fill in file path, sheet name, and sum range!');
                return;
            }

            const ranges = document.querySelectorAll('.sfs-range');
            const criterias = document.querySelectorAll('.sfs-criteria');

            if (ranges.length === 0 || !ranges[0].value || !criterias[0].value) {
                alert('Please fill in at least one criteria range and cell!');
                return;
            }

            let formula;
            if (lock) {
                formula = `=IFERROR(SUMIFS('[${filePath}]${sheetName}'!${sumRange}`;
                for (let i = 0; i < ranges.length; i++) {
                    if (ranges[i].value && criterias[i].value) {
                        formula += `,'[${filePath}]${sheetName}'!${ranges[i].value}&"",${criterias[i].value}&""`;
                    }
                }
            } else {
                formula = `=IFERROR(SUMIFS('[${filePath}]${sheetName}'!${sumRange}`;
                for (let i = 0; i < ranges.length; i++) {
                    if (ranges[i].value && criterias[i].value) {
                        formula += `,'[${filePath}]${sheetName}'!${ranges[i].value}&"",${criterias[i].value}&""`;
                    }
                }
            }
            
            formula += `),"${errorStr}")`;

            document.getElementById('sfs-output').value = formula;
            document.getElementById('sfs-result').classList.add('show');
        }

        let sumIfsCriteriaCount = 1;

        function addSumIfsCriteria() {
            sumIfsCriteriaCount++;
            const container = document.getElementById('sfs-criteria-container');
            const criteriaDiv = document.createElement('div');
            criteriaDiv.className = 'criteria-group';
            criteriaDiv.innerHTML = `
                <button class="remove-criteria-btn" onclick="removeSumIfsCriteria(this)">Remove</button>
                <div class="grid-2">
                    <div class="input-group">
                        <label>Criteria Range ${sumIfsCriteriaCount}:</label>
                        <input type="text" class="sfs-range" placeholder="e.g., B:B">
                    </div>
                    <div class="input-group">
                        <label>Criteria Cell ${sumIfsCriteriaCount}:</label>
                        <input type="text" class="sfs-criteria" placeholder="e.g., B2">
                    </div>
                </div>
            `;
            container.appendChild(criteriaDiv);
        }

        function removeSumIfsCriteria(btn) {
            btn.parentElement.remove();
        }

        function resetForm(prefix) {
            const inputs = document.querySelectorAll(`[id^="${prefix}-"]`);
            inputs.forEach(input => {
                if (input.tagName === 'SELECT') {
                    input.selectedIndex = 0;
                } else if (input.type === 'checkbox') {
                    input.checked = true;
                } else {
                    input.value = '';
                }
            });
            
            if (prefix === 'sfs') {
                const container = document.getElementById('sfs-criteria-container');
                container.innerHTML = `
                    <div class="criteria-group">
                        <div class="grid-2">
                            <div class="input-group">
                                <label>Criteria Range 1:</label>
                                <input type="text" class="sfs-range" placeholder="e.g., A:A">
                            </div>
                            <div class="input-group">
                                <label>Criteria Cell 1:</label>
                                <input type="text" class="sfs-criteria" placeholder="e.g., A2">
                            </div>
                        </div>
                    </div>
                `;
                sumIfsCriteriaCount = 1;
            }
            
            const resultBox = document.getElementById(`${prefix}-result`);
            if (resultBox) {
                resultBox.classList.remove('show');
            }
        }

        function copyToClipboard(textareaId) {
            const textarea = document.getElementById(textareaId);
            textarea.select();
            document.execCommand('copy');
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úÖ Copied!';
            btn.style.background = '#28a745';
            
            setTimeout(function() {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 2000);
        }
    </script>
</body>
</html>
