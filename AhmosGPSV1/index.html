<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöö</text></svg>"
        type="image/svg+xml" />
    <title>Ahmos GPS REVISION V1</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="weight-calibration.js"></script>
    <script src="summary-analysis.js"></script>
    <script src="file-handler.js"></script>
</head>

<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <span id="loadingText">Loading Sensor Data...</span>
    </div>

    <div class="container">
        <header>
            <div class="arabic-text" id="arabicText">&#x633;&#x64F;&#x628;&#x652;&#x62D;&#x64E;&#x627;&#x646;&#x64E;
                &#x627;&#x644;&#x644;&#x651;&#x64E;&#x647;&#x650;
                &#x648;&#x64E;&#x628;&#x650;&#x62D;&#x64E;&#x645;&#x652;&#x62F;&#x650;&#x647;&#x650;
                &#x633;&#x64F;&#x628;&#x652;&#x62D;&#x64E;&#x627;&#x646;&#x64E;
                &#x627;&#x644;&#x644;&#x651;&#x64E;&#x647;&#x650;
                &#x627;&#x644;&#x652;&#x639;&#x64E;&#x638;&#x650;&#x64A;&#x645;&#x650;</div>
            <h1>
                <span>üöö</span>
                Ahmos GPS Devices Revision Dashboard V1
            </h1>
            <p class="subtitle">Real-time monitoring with advanced weight calibration and event detection</p>

            <div class="date-range" id="dateRange">
                <!-- Date range will be populated here -->
            </div>
        </header>

        <div class="main-controls">
            <div class="global-controls">
                <button class="control-btn" onclick="GPSDashboard.expandAllDevices()">
                    <span>üìÇ</span> Expand All
                </button>
                <button class="control-btn" onclick="GPSDashboard.collapseAllDevices()">
                    <span>üìÅ</span> Collapse All
                </button>
                <button class="control-btn secondary" onclick="GPSDashboard.selectAllSensors()">
                    <span>‚úÖ</span> All Sensors
                </button>
                <button class="control-btn secondary" onclick="GPSDashboard.deselectAllSensors()">
                    <span>‚ùå</span> Deselect All
                </button>
                <!-- Optional: Global view toggle button -->
                <button class="control-btn" onclick="GPSDashboard.toggleAllViewMode()" id="toggleViewBtn">
                    <span>üìä</span> Graph View
                </button>
                <button class="control-btn secondary" onclick="GPSDashboard.showSummaryView()">
                    <span>üìã</span> Summary View
                </button>
                <button class="control-btn" onclick="GPSDashboard.refreshData()">
                    <span>üîÑ</span> Refresh
                </button>

                <!-- File Operations -->
                <label class="control-btn file-btn">
                    <span>üìÅ</span> Load JSON
                    <input type="file" id="jsonFileInput" accept=".json" style="display: none;"
                        onchange="FileHandler.loadJsonFile(event)">
                </label>
                <button class="control-btn secondary" onclick="FileHandler.saveDashboard()">
                    <span>üíæ</span> Save Dashboard
                </button>
                <button class="control-btn" onclick="GPSDashboard.loadSampleData()">
                    <span>üìä</span> Sample Data
                </button>
            </div>

            <div class="weight-calibration-controls">
                <select id="weightUnit" onchange="WeightCalibration.setWeightUnit(this.value)">
                    <option value="mV">Raw mV</option>
                    <option value="tons">Tons</option>
                    <option value="kg">Kilograms</option>
                </select>
                <button class="control-btn small" onclick="WeightCalibration.showCalibrationModal()">
                    <span>‚öñÔ∏è</span> Calibrate
                </button>
            </div>
        </div>

        <div class="devices-container" id="devicesContainer">
            <div class="empty-state" id="emptyState">
                <h3>No Device Data Available</h3>
                <p>Load JSON data or click "Sample Data" to see the dashboard in action.</p>
                <div class="empty-state-actions">
                    <button class="control-btn" onclick="GPSDashboard.loadSampleData()">
                        <span>üìä</span> Load Sample Data
                    </button>
                    <label class="control-btn secondary file-btn">
                        <span>üìÅ</span> Load JSON File
                        <input type="file" accept=".json" style="display: none;"
                            onchange="FileHandler.loadJsonFile(event)">
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Calibration Modal -->
    <div class="modal" id="calibrationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öñÔ∏è Weight Calibration Settings</h3>
                <button class="modal-close" onclick="WeightCalibration.hideCalibrationModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="calibration-section">
                    <h4>Calibration Points</h4>
                    <div id="calibrationPoints">
                        <!-- Points will be added here -->
                    </div>
                    <button class="control-btn small" onclick="WeightCalibration.addCalibrationPoint()">
                        <span>‚ûï</span> Add Point
                    </button>
                </div>
                <div class="calibration-formula">
                    <h4>Formula: <code id="currentFormula">Linear Interpolation</code></h4>
                    <p>Current calibration will use linear interpolation between points.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="control-btn" onclick="WeightCalibration.applyCalibration()">
                    Apply Calibration
                </button>
                <button class="control-btn secondary" onclick="WeightCalibration.hideCalibrationModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div class="modal" id="summaryModal">
        <div class="modal-content wide">
            <div class="modal-header">
                <h3>üìä Event Summary Analysis</h3>
                <button class="modal-close" onclick="SummaryAnalysis.hideSummaryModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="summary-controls">
                    <div class="summary-param">
                        <label>Grouping Threshold (%):</label>
                        <input type="number" id="groupThreshold" value="10" min="1" max="100"
                            onchange="SummaryAnalysis.updateGroupingThreshold(this.value)">
                    </div>
                    <div class="summary-param">
                        <label>Minimum Duration (minutes):</label>
                        <input type="number" id="minDuration" value="5" min="1"
                            onchange="SummaryAnalysis.updateMinDuration(this.value)">
                    </div>
                </div>
                <div id="summaryResults">
                    <!-- Summary results will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- App Configuration -->
    <script>
        // App configuration
        const AppConfig = {
            version: '1.0.0',
            defaultCalibrationPoints: [
                { raw: 0, calibrated: 0 },
                { raw: 1000, calibrated: 1000 },
                { raw: 2000, calibrated: 2000 },
                { raw: 3000, calibrated: 3000 }
            ],
            eventGroupingThreshold: 0.1, // 10%
            minEventDuration: 5 * 60 * 1000, // 5 minutes
            viewMode: 'graph', // 'graph' or 'table'
            autoSave: true
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function () {
            WeightCalibration.init(AppConfig.defaultCalibrationPoints);
            setTimeout(() => {
                if (Object.keys(GPSDashboard.appState.devices).length === 0) {
                    // Auto-load sample data for demo
                    GPSDashboard.loadSampleData();
                }
            }, 500);
        });
    </script>

    <!-- Main App -->
    <script src="app.js"></script>
</body>

</html>